.PAGE 'ASMPRINT'

; MAKE AN ENTRY IN LENGTH TABLE
;   X CONTAINS COL. FOR ERROR
;   Y CONTAINS LENGTH
;   A CONTAINS ERROR CODE

LTINS	PHA
	TYA
	PHA
	LDY #0
	STA LTAB,Y
	INY
	TXA
	STA LTAB,Y
	INY
	PLA
	TAX
	LDA IPC
	STA LTAB,Y
	INY
	LDA IPC+1
	STA LTAB,Y
	INY
	PLA
	STA LTAB,Y
	INY
	LDA ICRDNO+1
	STA LTAB,Y

; ADJUST RELATIVE BRANCH

	CPX #$FF        ;-1?
	BNE L20         ;NO...
	LDX #0
L20	CPX #4
	BNE L30
	DEY
	LDA LTAB,Y      ;GET ERROR CODE
	CMP #201
	BNE L30
	LDX #2
L30	CPX #3          ;CHECK FOR DBYTE
	BNE L31         ;ONLY INCREMENT
	DEY
	LDA LTAB,Y
	CMP #202
	BNE L31
	LDX #2
L31	TXA
	CLC
	ADC IPC         ;IPC + KINC
	STA IPC
	LDA IPC+1
	ADC #0
	STA IPC+1
	LDA PASS        ;WHICH PASS?
	BNE P2PRI       ;PASS2--LIST...
	RTS             ;DON'T LIST IN PASS1

P2PRI	LDY #4
	LDA LTAB,Y      ;ERROR FLAG
	BNE P204
	JMP PRTLN

P204	CMP #203        ;.PAGE?
	BNE P201
	SEC
	LDY #1
	LDA LTAB,Y      ;COLUMN FOR TITLE
	JMP SKPG        ;DO A PAGE...CARRY SET

P201	CMP #204        ;.SKIP ?
	BNE P202
	LDY #1
	LDA LTAB,Y      ;GET COL PTR
	BNE M121
	CLC
	ADC #1
	BNE M124
M121	TAX
	JSR EVAL
	LDA RETURN      ;GOOD EVAL?
	BNE M122        ;NO...
	LDA IEXP+1
M124	CLC
	JMP SKPG

M122	CMP #1          ;CORRECT ERROR CODE
	BEQ P202
	LDA #$13
P202	CMP #205        ;.END ?
	BEQ P205
	STA LEROR
	JMP ERRHND

P205	LDA #0          ;PRINT .LIB, .FIL, .END
	STA IERR
	JMP PRXX

.PAGE
; ************************
; *                      *
; * SYMBOL TABLE LISTING *
; *                      *
; ************************

NSTAT	;PRINT SYM TABLE
	LDA STSAVE
	STA SYMTBL
	LDA STSAVE+1
	STA SYMTBL+1
	LDA LNCT
	CMP #LINES-6
	BCS XXXH
	JSR PAGEHD
	JMP XXXJ

XXXH	JSR PAGE        ;NEXT PAGE
XXXJ	LDA #1
	STA TOPPNT+1
	LDA #0
	STA TOPPNT
	STA KLEN        ;CLEAR PRINT COUNTER
R20	SEC
	LDA NOSYM+1
	SBC TOPPNT+1
	LDA NOSYM
	SBC TOPPNT
	BCC R50
	LDA LNCT
	CMP #LINES
	BMI R42
	JSR PAGE
R42	JSR OUTCL1
	LDY #0
R41	LDA (SYMTBL),Y
	JSR OUTPUT      ;PRINT SYMBOL
	INY
	CPY #6
	BNE R41
	JSR OUTCL3
	LDA (SYMTBL),Y
	JSR NUMA        ;PRINT SYMBOL VALUE
	INY
	LDA (SYMTBL),Y
	JSR NUMA
	INC KLEN
	LDA KLEN
	CMP #4
	BEQ R44
	JSR OUTCL3
	JMP R43

R44	LDA #0
	STA KLEN
	JSR CRLF
	INC LNCT

R43	LDA SYMTBL
	CLC
	ADC #8
	STA SYMTBL
	BCC L14BB
	INC SYMTBL+1
L14BB	INC TOPPNT+1
	BNE L14C1
	INC TOPPNT
L14C1	JMP R20
R50	RTS



;
; SYMBOL TABLE PAGE ROUTINE
;

PAGE	JSR TOPPAG
	LDA #256-3
	STA LNCT
PAGEHD	LDX #STTTL-MSGS
	JSR MSG
	LDA LNCT
	CLC
	ADC #5
	STA LNCT
	RTS



;
; HOME FEED ROUTINE
;

TOPPAG	LDY LNCT
R5B	CPY #LINES
	BCS R5A
	JSR CRLF
	INY
	BNE R5B
R5A	JSR CR2



CR4	JSR CRLF
CR3	JSR CRLF
CR2	JSR CRLF
	JMP CRLF

.PAGE
; SKIP AND PAGE ROUTINE
;
;   CARRY SET TO PAGE, CLEAR TO SKIP.
;   ACC IS NUMBER OF LINES TO SKIP OR PNTR TO ICRD WHERE TITLE IS
;
;   IF POINTER=0 OLD HEADING USED
;   0 LINES TO SKIP-1 LINE SKIPPED

SKPG	PHP
	PHA
	LDA #4
	AND IFLAGS      ;NO LIST RUN ??
	BNE N11
	PLA
	PLP
	RTS

N11	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	PLA
	PLP
	BCC N90         ;IS SKIP


; IS PAGE - DO WE HAVE A TITLE?

SKPG1	TAX
	BEQ PTTTL       ;NO-USE OLD ONE
	LDY #0          ;Y IS TITLE LENGTH
N10	LDA ICRD+1,X
	CPY #20         ;MAXIMUM TITLE LENGTH
	BEQ N15
	CMP #$27        ;APPOSTROPHE
	BEQ N15
	STA LTLBUF,Y
	INY
	INX
	CPX IMAXCL
	BMI N10
	BEQ N10
N15	STY LTLLEN      ;LENGTH OF TITLE



; INCREMENT PAGE NUMBER & PRINT TITLE & PAGE NUMBER

PTTTL	INC LPGCT       ;INC. PAGNUM
	JSR TOPPAG
PTTTL0	LDY #0          ;PRINT TITLE
N40	CPY LTLLEN      ;ANY TITLE ??
	BEQ NCV
N50	LDA LTLBUF,Y
	JSR OUTPUT
	INY
	CPY LTLLEN
	BMI N50

NCV	LDX #6          ;PRINT 6 PERIODS
N60	LDA #'.'
	JSR OUTPUT
	DEX
	BNE N60

	LDX #PG-MSGS
	JSR MSG
	LDA LPGCT
	JSR HEXDEC

	LDX #16
	JSR MSG
	LDA #3
	STA LNCT
	RTS

N90	TAY
	ADC LNCT
	CMP #LINES
	BPL PTTTL
	STA LNCT
XXXI	JSR CRLF
	DEY
	BMI XXXK
	BNE XXXI
XXXK	RTS




; ========================
; = END OF ASSEMBLY CODE =
; ========================

PASS3	LDA #2
	CLC             ;FOR SKIP DIRECTIVE
	JSR SKPG        ;SKIP PAGE
	LDX #LINES
	DEX
	CPX LNCT
	BCS M8811
	LDA #0
	SEC             ;FOR A PAGE
	JSR SKPG        ;SKIP PAGE
M8811	INC LBOTH

;   LDX P1ERR   ;ANY PASS 1 ERRORS ?
;   BEQ M8810   ;NO
;
;   LDX #PSERR-MSGS
;   JSR MSG

M8810	LDX #NUMERR-MSGS
	JSR MSG
	LDA LERCT       ;ERROR COUNT
	JSR HEXDEC      ;MAKE IT DECIMAL
	DEC LBOTH
	JSR CRLF
	INC LNCT
	LDA #$40
	AND IFLAGS      ;SYMBOLS NEEDED?
	BEQ M8813       ;NO...

	LDA NOPRIN
	BNE M8813
	LDA NOSYM
	ORA NOSYM+1     ;ANY SYMBOL TO SORT?
	BEQ M8813       ;NO...
	JSR L15D1
	JSR NSTAT       ;PRINT SYMBOL TABLE
	JSR CRLF
M8813	INC LBOTH
	LDX #DNMSG-MSGS
	JSR MSG
	DEC LBOTH
	JMP DONE

L15D1	LDX #1
L15D3	LDA NOSYM,X
	STA IPC,X
	LDA STSAVE,X
	STA PNT1,X
	DEX
	BPL L15D3
L15DF	LDA PNT1
	CLC
	ADC #8
	STA PNT2
	LDA PNT1+1
	ADC #0
	STA PNT2+1
	LDY IPC
	LDA IPC+1
	SEC
	SBC #1
	BCS L15F6
	DEY
L15F6	STY TBLPTR
	STA TBLPTR+1
	ORA TBLPTR
	BNE L15FF
	RTS

L15FF	LDY #0
L1601	LDA (PNT1),Y
	CMP (PNT2),Y
	BMI L161F
	BNE L1610
	INY
	CPY #6
	BNE L1601
	BEQ L161F
L1610	LDY #$07
L1612	LDA (PNT2),Y
	PHA
	LDA (PNT1),Y
	STA (PNT2),Y
	PLA
	STA (PNT1),Y
	DEY
	BPL L1612
L161F	LDA PNT2
	CLC
	ADC #8
	STA PNT2
	BCC L162A
	INC PNT2+1
L162A	DEC TBLPTR+1
	LDA TBLPTR+1
	CMP #$FF
	BNE L1634
	DEC TBLPTR
L1634	ORA TBLPTR
	BNE L15FF
	LDA PNT1
	CLC
	ADC #8
	STA PNT1
	BCC L1643
	INC PNT1+1
L1643	DEC IPC+1
	LDA IPC+1
	CMP #$FF
	BNE L15DF
	DEC IPC
	JMP L15DF

.PAGE
; *************************
; *
; * PRTLN - PRINT ROUTINE
; * PRINTS ONE OUTPUT LINE
; *
; *************************

PRTLN	LDA LTAB+4
	STA IERR
	LDA #4
	AND IFLAGS      ;LIST OPTION?
	BNE PRXX
	LDA IERR
	BNE PRXXA
PRX1	RTS             ;DO NOT LIST THIS CARD

PRXXA	LDA IFLAGS
	AND #16         ;ERRORS PRINT?
	BEQ PRX1        ;NO...
PRXX	LDA LTAB+2
	STA IPC
	LDA LTAB+3
	STA IPC+1
	LDA LTAB
Q5	PHA
	LDA LTAB+5
	PHA             ;SAVE ON STACK
	LDA #0
	STA COLCNT
	LDA LNCT        ;LINE COUNT
	BEQ Q10         ;IF ZERO - PAGE
	CMP #LINES      ;OVER THE LIMIT?
	BCC Q20         ;NO
Q10	LDA #0          ;NEED TO PAGE
	SEC
	JSR SKPG        ;PAGE ROUTINE
Q20	LDA ICRDNO      ;A=CARD # HI
	BEQ XXXM3
	TAX
	LDA #0
	STA TEMB
XXXM1	DEX
	BMI XXXM2
	SED
	CLC
	ADC #$56
	STA TEMB+1
	LDA TEMB
	ADC #$02
	STA TEMB
	CLD
	LDA TEMB+1
	JMP XXXM1

XXXM2	PLA
	JSR L1A27
	JMP XXXM4

XXXM3	PLA
	JSR HEXDEC
XXXM4	INC COLCNT
	INC COLCNT
	JSR OUTCL2      ;PRINT TWO BLANKS

	LDY #0
	PLA
	TAX
	LDA IPC+1
	JSR NUMC2
	LDA IPC
	JSR NUMC2
	JSR OUTCL2
	TXA
	BMI Q44
	CMP #4
	BMI Q44
	LDX #2
	SEC
	SBC #2
	.BYTE $2C

Q44	LDA #0
	PHA
Q50	DEX             ;DEC BYTES LEFT
	BMI Q60         ;0 OR MORE-PRINT NEXT
	LDA OBJMAP,Y    ;GET THE BYTE
	JSR NUMC2
	JSR OUTCL1
	INY
	INC IPC
	BNE Q55
	INC IPC+1
Q55	JMP Q50

; PRINT CARD IF SUPPOSED TO

Q60	LDA LCDPT       ;PRINT FLAG
	BEQ *+5
	JMP Q80A

; NEED TO PRINT THE CARD

	LDY COLCNT
Q65	JSR BLANK
	INY             ;INCR FOR BLANK
	CPY #22         ;RIGHT COLUMN FOR CARD
	BMI Q65         ;NO, PRINT MORE
	INC IMAXCL
	LDX #0          ;X POINTS TO CARD
	LDA IERR
	BNE Q70         ;DON'T TAB ERRORS
	LDA ICRD
	CMP #';'    ;DON'T TAB COMMENT
	BEQ Q70
	LDY #0
	LDA JLABL
	BEQ Q74
Q73	LDA ICRD,X
	INX
	CMP #' '
	BNE Q72         ;NOT BLANK
	CPX IMAXCL
	BEQ Q80         ;RAN OUT OF CARD
	BNE Q73
Q72	JSR OUTPUT      ;OUTPUT LABEL
	INY
	CPX IMAXCL
	BEQ Q80         ;RAN OUT OF CARD
	LDA ICRD,X
	INX
	CMP #$20
	BNE Q72         ;STILL LABEL
	JSR OUTPUT
	INY
Q74	CPY #7
	BCS Q75
	JSR BLANK
	INY
	BNE Q74
Q75	LDA ICRD,X      ;DO NOT PRINT OP
	CMP #$20        ;UNTIL NONBLANK
	BNE Q70
	INY
	INX
	CPX IMAXCL
	BEQ Q80
	BNE Q75
Q70	CPX IMAXCL
	BEQ Q80         ;OUT OF CARD
	LDA ICRD,X      ;GET OPCODE

; TAB COMMENT FIELD

	CMP #';'
	BNE Q70AA
	PHA
	LDA ICRD-1,X    ;GET PREVIOUS
	CMP #' '
	BNE Q70A
Q70B	CPY #23
	BCS Q70A
	JSR BLANK
	INY
	BNE Q70B
Q70A	PLA
Q70AA	INX
	JSR OUTPUT
	INY
	BNE Q70
Q80	DEC IMAXCL
Q80A	JSR CRLF
	INC LNCT        ;LINE COUNT
	INC LCDPT       ;FLAG A 2ND LINE
	PLA             ;BYTES LEFT OFF STACK
	BEQ Q90         ;NONE LEFT-DONE
	TAX
	LDA IFLAGS      ;NOGEN OPTION?
	BMI Q90A        ;YES...
	TXA
	JMP Q5          ;GET NEXT LINE

; NOGEN OPTION, UPDATE PC

Q90A	TXA
	CLC
	ADC IPC
	STA IPC
	BCC Q90
	INC IPC+1
Q90	RTS



NUMC2	INC COLCNT
	INC COLCNT
	JMP NUMA
OUTCL3	JSR OUTCL1
OUTCL2	JSR OUTCL1
OUTCL1	INC COLCNT
BLANK	LDA #' '
	JMP OUTPUT



; ERROR HANDLER

ERRHND	INC LBOTH
	LDA LNCT
	CMP #LINES      ;END OF PAGE?
	BMI P10         ;NO, SO PRINT ERROR
	LDA #0          ;YES,   SKIP A PAGE
	SEC
	JSR SKPG
P10	JSR PRTLN       ;PRINT THE LINE
	LDX #0          ;GET READY FOR ERROR
	JSR MSG
	LDA LEROR
	JSR NUMA
	LDX #11
L17E9	JSR BLANK
	DEX
	BNE L17E9
	PHA
	LDA LTAB+1      ;ERROR COLUMN #
	TAX
	PLA
P45	DEX
	BMI P50
	JSR OUTPUT
	JMP P45

P50	LDA #$5E        ;UP ARROW AT ERROR
	JSR OUTPUT
	JSR CRLF
	INC LNCT

P60
;   LDA PASS    ;IS IT PASS 1 ?
;   BNE P61     ;NO
;
;   LDA #$FF    ;SET PASS 1 ERROR FLAG
;   STA P1ERR

P61	INC LERCT
	DEC LBOTH
	RTS



; PRINT A 5 DIGIT DEC NUMBER
;

HEXDEC	LDX #0
	STX TEMB
	STX TEMB+1
L1A27	PHA
	CLC
	LSR A
	LSR A
	LSR A
	LSR A
	TAX
L1A2E	LDA TEMB+1
	DEX
	BMI L1A4B
	SED
	CLC
	ADC #$16
	STA TEMB+1
	CLD
	BCC L1A2E
	SED
	LDA TEMB
	ADC #0
	STA TEMB
	CLD
	JMP L1A2E

L1A4B	PLA
	AND #$0F
	CLC
	SED
	ADC #0
	ADC TEMB+1
	STA TEMB+1
	CLD
	BCC L1A65
	LDA TEMB
	SED
	ADC #0
	CLD
	STA TEMB
L1A65	LDA TEMB
	JSR NUMA
	LDA TEMB+1
	JMP NUMA


; PRINT HEX NUMBER IN A

NUMA	PHA
	LSR A
	LSR A
	LSR A
	LSR A
	JSR NOUT
	PLA
	AND #$0F
NOUT	CLC
	ADC #$30
	CMP #$3A
	BMI LT10
	CLC
	ADC #7
LT10	JMP OUTPUT

.END
